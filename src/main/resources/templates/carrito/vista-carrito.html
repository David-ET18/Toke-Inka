<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:with="pageTitle='Tu Carrito | Toke Inca'"
      th:insert="~{_layout :: html(content=~{::content})}">

<body>
<!-- Fragmento de contenido -->
<th:block th:fragment="content">
    
    <div class="container py-5 cart-view">

        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="fw-bold mb-0">Tu Carrito</h1>
                <p class="text-muted mb-0">Revisa tus prendas antes de finalizar.</p>
            </div>
            <a th:href="@{/productos}" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">
                <i class="bi bi-arrow-left me-2"></i> Seguir Comprando
            </a>
        </div>

        <!-- VISTA: Carrito Vacío -->
        <div th:if="${carrito == null or #lists.isEmpty(carrito.items)}" class="row justify-content-center">
            <div class="col-md-8">
                <div class="empty-cart-container">
                    <i class="bi bi-bag-x" style="font-size: 5rem;"></i>
                    <h2 class="mt-3">Tu bolsa está vacía</h2>
                    <p class="text-muted mb-4">Parece que aún no has encontrado tu estilo ideal.</p>
                    <a th:href="@{/productos}" class="btn btn-primary btn-lg rounded-pill px-5">
                        Ver Catálogo
                    </a>
                </div>
            </div>
        </div>

        <!-- VISTA: Carrito con Productos -->
        <!-- La clase 'row g-5' es necesaria para que tu JS encuentre el contenedor -->
        <div th:if="${carrito != null and not #lists.isEmpty(carrito.items)}" class="row g-5">
            
            <!-- Columna Izquierda: Lista de Items -->
            <div class="col-lg-8">
                
                <!-- Encabezado de lista -->
                <div class="d-flex justify-content-between align-items-end border-bottom pb-3 mb-4">
                    <h5 class="mb-0 text-secondary fw-bold">Productos Agregados</h5>
                    <span class="badge bg-light text-dark border rounded-pill px-3" 
                          th:text="|${#lists.size(carrito.items)} prendas|"></span>
                </div>

                <!-- Iteración de Items -->
                <!-- MANTENEMOS LAS CLASES Y DATA ATTRIBUTES PARA EL JS -->
                <div th:each="item : ${carrito.items}" 
                     class="card cart-item-row" 
                     th:data-product-id="${item.productoId}" 
                     th:data-talla-id="${item.tallaId}">
                    
                    <div class="card-body p-4">
                        <div class="row align-items-center gy-3">
                            
                            <!-- Imagen -->
                            <div class="col-md-2 col-4">
                                <img th:src="${item.urlImagen != null ? item.urlImagen : 'https://via.placeholder.com/150'}" 
                                     class="img-fluid" alt="Producto">
                            </div>

                            <!-- Info -->
                            <div class="col-md-4 col-8">
                                <a th:href="@{/producto/{id}(id=${item.productoId})}" class="item-title h5 mb-1 d-block" th:text="${item.nombreProducto}">Nombre</a>
                                <p class="text-muted small mb-1 text-uppercase" th:text="|Talla: ${item.nombreTalla}|">Talla</p>
                                <p class="text-muted small mb-0" th:text="|Unitario: S/ ${#numbers.formatDecimal(item.precioUnitario, 1, 'COMMA', 2, 'POINT')}|"></p>
                            </div>

                            <!-- Cantidad (Controles JS) -->
                            <div class="col-md-3 col-6 d-flex justify-content-md-center">
                                <div class="quantity-control shadow-sm">
                                    <button class="btn btn-minus" type="button"><i class="bi bi-dash"></i></button>
                                    <input type="text" class="quantity-input" th:value="${item.cantidad}" readonly>
                                    <button class="btn btn-plus" type="button"><i class="bi bi-plus"></i></button>
                                </div>
                            </div>

                            <!-- Subtotal y Eliminar -->
                            <div class="col-md-3 col-6 text-end">
                                <p class="fw-bold fs-5 mb-2 item-subtotal text-primary" 
                                   th:text="|S/ ${#numbers.formatDecimal(item.getSubtotal(), 1, 'COMMA', 2, 'POINT')}|"></p>
                                
                                <button class="btn btn-sm btn-delete px-3 py-1">
                                    <i class="bi bi-trash3 me-1"></i> Quitar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Resumen (Sticky) -->
            <div class="col-lg-4">
                <div class="summary-card">
                    <h4 class="mb-4">Resumen del Pedido</h4>
                    
                    <ul class="list-group list-group-flush mb-4">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Subtotal</span>
                            <span id="subtotal-summary" class="fw-bold" 
                                  th:text="|S/ ${#numbers.formatDecimal(carrito.total, 1, 'COMMA', 2, 'POINT')}|"></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Envío</span>
                            <span class="text-success fw-bold"><i class="bi bi-truck me-1"></i>Gratis</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center mt-2">
                            <span>Total a Pagar</span>
                            <strong id="grand-total" class="fs-4 text-primary" 
                                    th:text="|S/ ${#numbers.formatDecimal(carrito.total, 1, 'COMMA', 2, 'POINT')}|"></strong>
                        </li>
                    </ul>

                    <div class="d-grid">
                        <a th:href="@{/checkout}" class="btn btn-checkout text-white">
                            Proceder al Pago <i class="bi bi-credit-card ms-2"></i>
                        </a>
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted d-block mb-2"><i class="bi bi-shield-lock"></i> Compra 100% Segura</small>
                        <div class="opacity-50">
                            <i class="bi bi-credit-card-2-front fs-5 mx-1"></i>
                            <i class="bi bi-paypal fs-5 mx-1"></i>
                            <i class="bi bi-bank fs-5 mx-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

</body>
</html>