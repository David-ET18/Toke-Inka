<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:with="pageTitle='Detalle del Pedido | Toke Inca'"
      th:insert="~{_layout :: html(content=~{::content})}">

<th:block th:fragment="content">
    <div class="container py-5 account-container">
        
        <!-- Breadcrumb -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/}" class="text-decoration-none text-muted">Inicio</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/mis-pedidos}" class="text-decoration-none text-muted">Mis Pedidos</a></li>
                        <li class="breadcrumb-item active text-primary fw-bold" aria-current="page" th:text="|Pedido #${pedido.id}|"></li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row g-4">
            
            <!-- COLUMNA IZQUIERDA: NAVEGACIÓN -->
            <div class="col-lg-3">
                <div class="list-group account-nav sticky-top" style="top: 100px; z-index: 1;">
                    <a th:href="@{/mi-cuenta}" class="list-group-item list-group-item-action">
                       <i class="bi bi-person-bounding-box me-3"></i> Mi Perfil
                    </a>
                    <a th:href="@{/mis-pedidos}" class="list-group-item list-group-item-action active">
                       <i class="bi bi-bag-check-fill me-3"></i> Mis Pedidos
                    </a>
                    <form th:action="@{/logout}" method="post" class="w-100 m-0 p-0">
                        <button type="submit" class="list-group-item list-group-item-action text-danger border-top mt-2">
                            <i class="bi bi-box-arrow-left me-3"></i> Cerrar Sesión
                        </button>
                    </form>
                </div>
            </div>

            <!-- COLUMNA DERECHA: DETALLE -->
            <div class="col-lg-9 account-content">
                <div class="card order-detail-card" th:object="${pedido}">
                    
                    <!-- Encabezado de la Tarjeta -->
                    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-3">
                        <div class="d-flex align-items-center gap-3">
                            <a th:href="@{/mis-pedidos}" class="btn btn-outline-secondary btn-sm rounded-circle shadow-sm">
                                <i class="bi bi-arrow-left"></i>
                            </a>
                            <h4 class="mb-0 fw-bold text-secondary">Detalle del Pedido</h4>
                        </div>
                        
                        <!-- Botón de Descarga PDF -->
                        <a th:href="@{/mis-pedidos/{id}/boleta(id=*{id})}" target="_blank" class="btn btn-danger btn-sm rounded-pill px-3 shadow-sm">
                            <i class="bi bi-file-earmark-pdf-fill me-2"></i> Descargar Boleta
                        </a>
                    </div>

                    <div class="card-body p-4 p-md-5">
                        
                        <!-- Fila de Resumen (Info Boxes) -->
                        <div class="row g-4 mb-5 pb-4 border-bottom">
                            <div class="col-md-4">
                                <div class="info-box">
                                    <h6><i class="bi bi-calendar3 me-1"></i> Fecha del Pedido</h6>
                                    <p th:text="${#temporals.format(pedido.fechaPedido, 'dd MMM yyyy, HH:mm')}"></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <h6><i class="bi bi-activity me-1"></i> Estado Actual</h6>
                                    <!-- Badges con lógica de colores -->
                                    <span class="badge rounded-pill px-3 py-2 fw-normal" 
                                          th:text="*{estado}" 
                                          th:classappend="${
                                            pedido.estado.name() == 'PENDIENTE_PAGO' ? 'bg-warning text-dark' : 
                                            (pedido.estado.name() == 'PAGADO' ? 'bg-success' : 
                                            (pedido.estado.name() == 'ENVIADO' ? 'bg-info text-dark' : 
                                            (pedido.estado.name() == 'COMPLETADO' ? 'bg-primary' : 'bg-danger')))
                                          }">
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-box">
                                    <h6><i class="bi bi-cash-coin me-1"></i> Total Pagado</h6>
                                    <p class="text-primary" th:text="|S/ ${#numbers.formatDecimal(pedido.total, 1, 'COMMA', 2, 'POINT')}|"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Fila de Productos y Envío -->
                        <div class="row g-5">
                            
                            <!-- Lista de Productos -->
                            <div class="col-lg-7">
                                <h5 class="mb-4 fw-bold text-secondary">Productos Comprados</h5>
                                <div class="d-flex flex-column gap-2">
                                    <div th:each="detalle : *{detalles}" class="product-list-item d-flex align-items-center">
                                        
                                        <!-- Imagen con validación -->
                                        <img th:src="@{${detalle.urlImagen != null ? detalle.urlImagen : 'https://via.placeholder.com/80'}}" 
                                             width="80" height="80" class="me-3 object-fit-cover" alt="Producto">
                                        
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold text-dark" th:text="${detalle.nombreProducto}">Producto</h6>
                                            <small class="text-muted d-block text-uppercase" style="font-size: 0.75rem;">
                                                Talla: <span class="fw-bold text-dark" th:text="${detalle.nombreTalla}"></span>
                                            </small>
                                            <small class="text-muted">
                                                Cant: <span class="fw-bold" th:text="${detalle.cantidad}"></span>
                                            </small>
                                        </div>
                                        
                                        <div class="text-end">
                                            <span class="fw-bold text-secondary" 
                                                  th:text="|S/ ${#numbers.formatDecimal(detalle.precioUnitario, 1, 'COMMA', 2, 'POINT')}|"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Información de Envío -->
                            <div class="col-lg-5">
                                 <div class="shipping-card">
                                     <h5 class="fw-bold text-secondary"><i class="bi bi-geo-alt-fill me-2 text-primary"></i>Datos de Envío</h5>
                                     
                                     <div class="mt-3">
                                         <small class="text-muted d-block text-uppercase mb-1">Dirección de Entrega</small>
                                         <p class="fw-bold mb-3" th:text="*{direccionEnvio}">Av. Siempre Viva 123</p>
                                         
                                         <!-- Puedes agregar ciudad/país si los tienes en el objeto -->
                                         <div th:if="${pedido.ciudadEnvio}">
                                             <small class="text-muted d-block text-uppercase mb-1">Ciudad</small>
                                             <p class="fw-bold mb-0" th:text="${pedido.ciudadEnvio}"></p>
                                         </div>
                                     </div>
                                     
                                     <div class="mt-4 pt-3 border-top border-light">
                                         <div class="d-flex align-items-center text-success">
                                             <i class="bi bi-truck me-2 fs-4"></i>
                                             <span class="fw-bold">Envío Standard</span>
                                         </div>
                                     </div>
                                 </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>
</html>