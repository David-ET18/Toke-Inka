<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:with="pageTitle='Gestión de Productos | Admin'"
      th:insert="~{_layout :: html(content=~{::content})}">

<th:block th:fragment="content">
    <div class="container py-5 admin-container">
        
        <!-- Cabecera Admin -->
        <div class="admin-header d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1">Inventario</h1>
                <p class="mb-0 text-muted">Gestiona el catálogo de productos de la tienda.</p>
            </div>
            <a th:href="@{/admin/productos/nuevo}" class="btn btn-primary rounded-pill px-4 shadow-sm">
                <i class="bi bi-plus-lg me-2"></i>Nuevo Producto
            </a>
        </div>

        <!-- Navegación Interna (Pills) -->
        <div class="nav-admin mb-4">
            <a class="nav-link" th:href="@{/admin/dashboard}">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <!-- ACTIVO -->
            <a class="nav-link active" th:href="@{/admin/productos}">
                <i class="bi bi-box-seam"></i> Productos
            </a>
            <a class="nav-link" th:href="@{/admin/pedidos}">
                <i class="bi bi-receipt"></i> Pedidos
            </a>
        </div>
        
        <!-- Alertas -->
        <div th:if="${mensaje}" class="alert alert-success d-flex align-items-center shadow-sm border-0 mb-4">
            <i class="bi bi-check-circle-fill me-2 fs-5"></i>
            <span th:text="${mensaje}"></span>
        </div>

        <!-- Tarjeta de la Tabla -->
        <div class="admin-table-card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Producto</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Estado</th> <!-- Puedes agregar lógica de stock aquí -->
                            <th class="text-end pe-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Estado Vacío -->
                        <tr th:if="${#lists.isEmpty(productos)}">
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-3 opacity-25"></i>
                                No hay productos registrados.
                            </td>
                        </tr>

                        <!-- Iteración -->
                        <tr th:each="producto : ${productos}">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="position-relative me-3">
                                        <img th:src="@{${producto.urlImagen != null ? producto.urlImagen : 'https://via.placeholder.com/50'}}" 
                                             class="img-thumbnail-table" alt="Prod">
                                        <span class="position-absolute top-0 start-0 translate-middle badge rounded-pill bg-secondary" 
                                              style="font-size: 0.6rem;" th:text="${producto.id}">ID</span>
                                    </div>
                                    <div>
                                        <span class="fw-bold text-dark d-block" th:text="${producto.nombre}">Nombre</span>
                                        <!-- Opcional: Stock -->
                                        <!-- <small class="text-muted">Stock: 10</small> -->
                                    </div>
                                </div>
                            </td>
                            
                            <td>
                                <span class="badge bg-light text-secondary border fw-normal" 
                                      th:text="${producto.categoria != null ? producto.categoria.nombre : 'General'}">
                                </span>
                            </td>
                            
                            <td class="price-cell" th:text="|S/ ${#numbers.formatDecimal(producto.precio, 1, 'COMMA', 2, 'POINT')}|"></td>
                            
                            <td>
                                <span class="badge bg-success bg-opacity-10 text-success rounded-pill">Activo</span>
                            </td>

                            <td class="text-end pe-4">
                                <a th:href="@{/admin/productos/editar/{id}(id=${producto.id})}" 
                                   class="btn-action edit me-1" 
                                   data-bs-toggle="tooltip" title="Editar">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                
                                <!-- Botón Eliminar con SweetAlert -->
                                <button type="button" class="btn-action delete" 
                                        th:onclick="'confirmarEliminacion(' + ${producto.id} + ')'"
                                        title="Eliminar">
                                    <i class="bi bi-trash-fill"></i>
                                </button>

                                <!-- Formulario oculto para la eliminación real -->
                                <form th:id="'deleteForm-' + ${producto.id}" 
                                      th:action="@{/admin/productos/eliminar/{id}(id=${producto.id})}" 
                                      method="post" class="d-none">
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- SCRIPTS PARA SWEETALERT (Eliminación)      -->
    <!-- ========================================== -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Función de eliminación
        function confirmarEliminacion(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esta acción y el producto se borrará del catálogo.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545', // Rojo danger
                cancelButtonColor: '#6c757d',  // Gris
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Si confirma, envía el formulario oculto
                    document.getElementById('deleteForm-' + id).submit();
                }
            })
        }
        
        // --- SOLUCIÓN DEL ERROR: Esperar a que cargue Bootstrap ---
        window.addEventListener('load', function() {
            if (typeof bootstrap !== 'undefined') {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
        });
    </script>

</th:block>
</html>